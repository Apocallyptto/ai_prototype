version: "3.9"

services:
  postgres:
    image: postgres:16
    container_name: trader_postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: trader
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d trader || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  # --- your app image with tools/* scripts (used for one-off jobs & sync_orders)
  executor:
    image: ai_prototype-executor
    container_name: trader_executor
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # --- DB ---
      DB_URL: ${DB_URL:-postgresql://postgres:postgres@postgres:5432/trader}

      # --- Alpaca ---
      ALPACA_API_KEY: ${ALPACA_API_KEY}
      ALPACA_API_SECRET: ${ALPACA_API_SECRET}
      ALPACA_PAPER: ${ALPACA_PAPER:-1}

      # Optional defaults used by tools
      LOOKBACK_DAYS: "3"
      STALE_MINUTES: "20"

    command: >
      sh -lc 'sleep 999999'   # stays idle; you run one-off tools via `docker compose run --rm executor ...`
    restart: unless-stopped

  # --- the signal runner (polls DB and places entries)
  signal_executor:
    image: ai_prototype-signal_executor
    container_name: trader_signal_executor
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # --- DB ---
      DB_URL: ${DB_URL:-postgresql://postgres:postgres@postgres:5432/trader}

      # --- Symbols / filter ---
      SYMBOLS: ${SYMBOLS:-AAPL,MSFT,SPY,NVDA,AMD}
      MIN_STRENGTH: ${MIN_STRENGTH:-0.60}
      PORTFOLIO_ID: ${PORTFOLIO_ID:-paper-core}

      # --- Sizing (either NOTIONAL_USD or FIXED_QTY) ---
      NOTIONAL_USD: ${NOTIONAL_USD:-}
      FIXED_QTY: ${FIXED_QTY:-0.05}

      # --- Alpaca ---
      ALPACA_API_KEY: ${ALPACA_API_KEY}
      ALPACA_API_SECRET: ${ALPACA_API_SECRET}
      ALPACA_PAPER: ${ALPACA_PAPER:-1}

      # --- Loop cadence ---
      POLL_SECONDS: ${POLL_SECONDS:-20}

    command: >
      python -m services.signal_executor
    restart: unless-stopped

  # --- NEW: keeps DB in sync with broker orders (both OPEN & CLOSED)
  sync_orders:
    image: ai_prototype-executor
    container_name: trader_sync_orders
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # --- DB ---
      DB_URL: ${DB_URL:-postgresql://postgres:postgres@postgres:5432/trader}

      # --- Alpaca ---
      ALPACA_API_KEY: ${ALPACA_API_KEY}
      ALPACA_API_SECRET: ${ALPACA_API_SECRET}
      ALPACA_PAPER: ${ALPACA_PAPER:-1}

      # --- Sync options ---
      LOOKBACK_DAYS: ${LOOKBACK_DAYS:-3}   # search window for broker orders
      STALE_MINUTES: ${STALE_MINUTES:-20}  # mark long-submitted rows w/o broker record as skipped
    command: >
      sh -lc 'while true; do
        python tools/sync_orders.py || true;
        sleep 60;
      done'
    restart: unless-stopped

# networks/volumes can be defaulted; add if you need named ones
